@using TD.Common.Kendo.Mvc5.Grid

@(Html.Kendo().Grid<TD.CTS.WebUI.Models.TrialProcedureViewModel>()
    .Name("ProceduresGrid")
    .Selectable(select => select.Type(GridSelectionType.Cell))
    .Editable()
    .Columns(columns =>
    {
        columns.Buttons(buttons => { buttons.Add(); buttons.Delete(); })
            .HeaderHtmlAttributes(new { style = "vertical-align:bottom;" })
            .HtmlAttributes(new { @class = "k-group-cell" }).Width(60);
        columns.ForeignKey(e => e.ProcedureCode, (System.Collections.IEnumerable)ViewBag.Procedures, "Code", "Name")
            .Width(400)
            .Filterable(false)
            .HeaderTemplate(@"<div style=""text-align:right;width:200px;""><a class='k-button k-button-icontext k-grid-addcolumn td-grid-button' title='Добавить визит' href='javascript: void(0)'><span class='k-icon k-add td-grid-button-image'></span></a></div><div style=""text-align:right;width:200px;"">Визиты</div><div>Процедуры</div>")
            .HtmlAttributes(new { @class = "k-group-cell" });

        var visits = (IEnumerable<TD.CTS.Data.Entities.TrialVisit>)ViewBag.Visits;
        foreach (var visit in visits)
        {
            columns.Template(e => { })
                .ClientTemplate("#= SelectedVisit(" + visit.Id + ", data) #")
                .HeaderTemplate(string.Format(@"<div style='text-align:center;'><a class='k-button k-button-icontext td-grid-editcolumn td-grid-button' href='javascript: void(0)' title='Изменить визит'><span class='k-icon k-edit td-grid-button-image'></span></a>
<a class='k-button k-button-icontext td-grid-deletecolumn td-grid-button' href='javascript: void(0)' title='Удалить визит'><span class='k-icon k-delete td-grid-button-image'></span></a><input type='hidden' value='{3}'/></div>
<div style=""text-align:center;"">{0}</div><div style=""text-align:center;"">{1}&plusmn;{2}</div>", visit.Name, visit.Days, visit.Punctuality, visit.Id))
                .HtmlAttributes(new { style = "text-align:center;" })
                .Width(100);

        }
        columns.Template(e => { }).ClientTemplate(" ").Width("100%").HtmlAttributes(new { @class = "k-group-cell" });

    })
    .DataSource(dataSource => dataSource
       .Ajax()
       .Model(model =>
       {
           model.Id(e => e.Id);
           model.Field(e => e.ProcedureCode).Editable(false);
       })
       .Read(read => read.Action("GetTrialProcedures", "Trials").Data("GetTrialCode"))
       .Create(create => create.Action("AddTrialProcedure", "Trials"))
       .Destroy(destroy => destroy.Action("DeleteTrialProcedure", "Trials"))
       .Events(events => events
           .Error("kendo_grid_error_handler").RequestEnd("RequestEnd"))
    )
    .Events(events => events
        .Edit("OnProcedureEdit")
        .Change("OnChange")
        .Save("OnProcedureSave")
        .Cancel("OnProcedureCancel"))
)

<div id="VisitMaterials" style="display:none;">
    <h4>Материалы</h4>
    @(Html.Kendo().Grid<TD.CTS.WebUI.Models.TrialVisitMaterialViewModel>()
        .Name("VisitMaterialsGrid")
        .Editable()
        .AutoBind(false)
        .Scrollable()
        .Columns(columns =>
        {
            columns.Buttons(buttons =>
            {
                buttons.Add();
                buttons.Delete();
            }).Width(50).HeaderHtmlAttributes(new { style = "text-align:right;" });
            columns.Bound(e => e.TrialMaterialId)
                .ClientTemplate("#= MaterialName #")
                .EditorTemplateName("VisitMaterialEditor")
                .Width(250).Title("Наименование материала");

            //columns.Bound(e => e.Quantity).Width(120).Title("Количество");
            columns.Template(e => { }).ClientTemplate(" ").Width("100%");
        })
        .DataSource(dataSource => dataSource
           .Ajax()
           .Model(model =>
           {
               model.Id(e => e.Id);
               //model.Field(e => e.Quantity).DefaultValue(1);
           })
           .Read(read => read.Action("GetTrialVisitMaterials", "Trials").Data("VisitMaterialsData"))
           .Create(create => create.Action("AddTrialVisitMaterial", "Trials"))
           .Destroy(destroy => destroy.Action("DeleteTrialVisitMaterial", "Trials"))
           .Events(events => events.Error("kendo_grid_error_handler").RequestEnd("OnVisitMaterialRequestEnd"))
        )
        .Events(events => events
            .Edit("OnVisitMaterialEdit")
            .Save("OnVisitMaterialsSave")
            .Cancel("OnVisitMaterialCancel"))
        .AutoBind(false)
    )
</div>

@(Html.Kendo().Window()
    .Name("VisitEdit")
    .Modal(true)
    .Draggable(true)
    .Title("Визит")
    .HtmlAttributes(new { @class = "k-popup-edit-form" })
    .Visible(false)
    .Events(events => events.Refresh("OpenVisitEdit"))
)

<script id="procedureTemplate" type="text/x-kendo-template">
    @(Html.Kendo().DropDownList()
        .Name("ProcedureCode")
        .DataTextField("Name")
        .DataValueField("Code")
        .DataSource(source =>
        {
            source.Read(read =>
            {
                read.Action("GetProcedures", "Trials").Data("GetTrialCode");
            });
        })
        .Value("#: value #")
        .ToClientTemplate()
    )
</script>

<script>
    var procGrid = $("#ProceduresGrid");

    procGrid.on("click", ".k-grid-add.td-grid-button", function () {
        ClearSelection();
        kendo_grid_createrow(procGrid);
        isProcedureEdit = true;
    });

    procGrid.on("click", ".k-grid-addcolumn.td-grid-button", function () {
        ClearSelection();
        LoadVisitEdit();
    });

    procGrid.on("click", ".td-grid-editcolumn.td-grid-button", function () {
        ClearSelection();
        var id = $(this).parent().find("input").val();
        LoadVisitEdit(id);
    });

    procGrid.on("click", ".td-grid-deletecolumn.td-grid-button", function () {
        ClearSelection();
        var id = $(this).parent().find("input").val();
        DeleteVisit(id);
    });

    $("#VisitMaterialsGrid .k-grid-add.td-grid-button").click(function () {
        kendo_grid_createrow($("#VisitMaterialsGrid"));
    });

</script>